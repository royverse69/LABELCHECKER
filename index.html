<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Label Health Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .result-card {
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
        }
        .result-card.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal Styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .clickable-additive {
            cursor: pointer;
            text-decoration: underline;
            color: #2563eb;
            font-weight: 500;
        }
        #camera-view {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
        /* Scanning Effect */
        .scanning::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(0, 255, 255, 0.7);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.9), 0 0 20px rgba(0, 255, 255, 0.9);
            animation: scan 2s ease-in-out infinite;
        }
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        /* Skeletal Loader */
        .skeleton-box {
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }
        /* Tap to Focus */
        .focus-ring {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: focus-anim 0.5s ease-out;
            pointer-events: none;
        }
        @keyframes focus-anim {
            0% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="main-container" class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8">
        <div class="text-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Advanced Health Label Analyzer</h1>
            <p class="text-gray-500 mt-2 text-sm sm:text-base">Get a professional health grade for your food.</p>
        </div>

        <!-- Uploader -->
        <div id="uploader" class="mt-8">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="camera-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 flex items-center justify-center space-x-2">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>
                    <span>Capture with Camera</span>
                </button>
                <button id="upload-button" class="w-full bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-gray-800 flex items-center justify-center space-x-2">
                     <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                    <span>Upload Image</span>
                </button>
            </div>
            <input type="file" id="fileInput" class="hidden" accept="image/*">
            <p class="text-center text-gray-500 mt-4 text-sm">You can also drag & drop or paste an image.</p>
        </div>
        
        <div id="imagePreviewContainer" class="mt-4 hidden text-center relative overflow-hidden rounded-lg">
            <img id="imagePreview" class="max-w-xs mx-auto rounded-lg shadow-md" alt="Image Preview">
            <button id="analyzeButton" class="mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Analyze Label</button>
        </div>

        <!-- Skeletal Loader -->
        <div id="loader" class="mt-8 hidden space-y-4">
            <div class="flex justify-center items-center flex-col space-y-3">
                <div class="skeleton-box w-20 h-20 rounded-full"></div>
                <div class="skeleton-box w-32 h-8"></div>
                <div class="skeleton-box w-48 h-6"></div>
            </div>
            <div class="space-y-3 pt-6">
                <div class="skeleton-box w-full h-16"></div>
                <div class="skeleton-box w-full h-16"></div>
                <div class="skeleton-box w-full h-16"></div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="mt-8 result-card">
            <div id="score-summary" class="text-center"></div>
            <div id="score-breakdown" class="mt-6 space-y-3"></div>
            
            <div id="chat-explainer" class="mt-8 pt-6 border-t border-gray-200 hidden">
                 <h3 class="text-xl font-bold text-gray-800 text-center">Want a simpler explanation?</h3>
                 <p class="text-center text-gray-500 text-sm mt-1">Tell us a bit about yourself for a personalized summary.</p>
                 <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                     <input id="user-age" type="number" placeholder="Your Age (e.g., 35)" class="p-2 border border-gray-300 rounded-lg">
                     <select id="user-lifestyle" class="p-2 border border-gray-300 rounded-lg">
                         <option value="sedentary">Sedentary (mostly sitting)</option>
                         <option value="lightly_active">Lightly Active</option>
                         <option value="active">Active</option>
                         <option value="very_active">Very Active</option>
                     </select>
                 </div>
                 <div class="text-center mt-4">
                    <button id="ask-why-button" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">ðŸ’¬ Ask Why?</button>
                 </div>
                 <div id="chat-response-container" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                    <div id="chat-response" class="text-gray-700 space-y-2 leading-relaxed"></div>
                 </div>
            </div>

            <div class="text-center mt-8">
                <button id="resetButton" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700">Analyze Another Label</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="additive-modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center hidden">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="closeModal()"></div>
        <div class="modal-content bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto">
            <div class="py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p id="modal-title" class="text-2xl font-bold"></p>
                    <div class="modal-close cursor-pointer z-50" onclick="closeModal()"><svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg></div>
                </div>
                <div id="modal-body" class="my-5 text-gray-700"><div class="loader mx-auto"></div></div>
            </div>
        </div>
    </div>
    
    <div id="camera-modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center hidden bg-black bg-opacity-75">
        <div class="bg-white w-full max-w-lg mx-auto rounded-lg shadow-lg z-50 p-4 flex flex-col relative">
            <video id="camera-view" autoplay playsinline></video>
            <canvas id="camera-canvas" class="hidden absolute top-4 left-4 rounded-lg"></canvas>
            <div id="camera-controls" class="mt-4 flex justify-around items-center">
                <button id="cancel-camera" class="p-3 bg-gray-300 text-gray-800 font-semibold rounded-full" onclick="closeCamera()">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
                <button id="capture-button" class="p-4 bg-blue-600 text-white font-bold rounded-full shadow-lg ring-4 ring-white ring-opacity-50">
                    <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
                <button id="flash-button" class="p-3 bg-gray-300 text-gray-800 font-semibold rounded-full hidden">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                </button>
            </div>
             <div id="recapture-controls" class="mt-4 flex justify-around items-center hidden">
                <button id="recapture-button" class="px-6 py-3 bg-gray-700 text-white font-semibold rounded-full">Recapture</button>
                <button id="use-photo-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-full">Use Photo</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_KEY = "AIzaSyCiPL-DcZN82CxH6OmYv9Ll4yM3WiVjxXY";
        const MODEL_NAME = "gemini-1.5-flash";

        // --- DOM ELEMENTS ---
        const mainContainer = document.getElementById('main-container');
        const uploader = document.getElementById('uploader');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('upload-button');
        const cameraButton = document.getElementById('camera-button');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeButton = document.getElementById('analyzeButton');
        const loader = document.getElementById('loader');
        const results = document.getElementById('results');
        const scoreSummary = document.getElementById('score-summary');
        const scoreBreakdown = document.getElementById('score-breakdown');
        const resetButton = document.getElementById('resetButton');
        const additiveModal = document.getElementById('additive-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const chatExplainer = document.getElementById('chat-explainer');
        const askWhyButton = document.getElementById('ask-why-button');
        const chatResponseContainer = document.getElementById('chat-response-container');
        const chatResponse = document.getElementById('chat-response');
        const cameraModal = document.getElementById('camera-modal');
        const cameraView = document.getElementById('camera-view');
        const cameraCanvas = document.getElementById('camera-canvas');
        const captureButton = document.getElementById('capture-button');
        const flashButton = document.getElementById('flash-button');
        const cameraControls = document.getElementById('camera-controls');
        const recaptureControls = document.getElementById('recapture-controls');
        const recaptureButton = document.getElementById('recapture-button');
        const usePhotoButton = document.getElementById('use-photo-button');

        let file = null;
        let lastAnalysisData = null;
        let stream = null;
        let flashOn = false;

        // --- ICONS ---
        const icons = {
            gradeA_plus: `<svg class="w-16 h-16 text-green-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            gradeA: `<svg class="w-16 h-16 text-green-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            gradeB: `<svg class="w-16 h-16 text-yellow-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`,
            gradeC: `<svg class="w-16 h-16 text-orange-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`,
            gradeD: `<svg class="w-16 h-16 text-red-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            carcinogen: `<svg class="w-5 h-5 text-red-600 inline-block ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`
        };

        // --- EVENT LISTENERS ---
        uploadButton.addEventListener('click', () => fileInput.click());
        cameraButton.addEventListener('click', openCamera);
        captureButton.addEventListener('click', capturePhoto);
        flashButton.addEventListener('click', toggleFlash);
        recaptureButton.addEventListener('click', recapturePhoto);
        usePhotoButton.addEventListener('click', usePhoto);
        cameraView.addEventListener('click', handleFocus);
        mainContainer.addEventListener('dragover', (e) => { e.preventDefault(); mainContainer.classList.add('dropzone-active'); });
        mainContainer.addEventListener('dragleave', () => { mainContainer.classList.remove('dropzone-active'); });
        mainContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            mainContainer.classList.remove('dropzone-active');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });
        analyzeButton.addEventListener('click', () => { if (file) getAnalysis(file); });
        resetButton.addEventListener('click', resetUI);
        document.addEventListener('paste', handlePaste);
        askWhyButton.addEventListener('click', getPersonalizedExplanation);

        // --- FUNCTIONS ---
        function handlePaste(e) {
            const items = e.clipboardData.files;
            if (items.length > 0 && items[0].type.startsWith('image/')) {
                e.preventDefault();
                handleFile(items[0]);
            }
        }

        function handleFile(inputFile) {
            if (!inputFile.type.startsWith('image/')) {
                alert('Please upload an image file.');
                return;
            }
            file = inputFile;
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                uploader.classList.add('hidden');
                imagePreviewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        async function openCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    cameraModal.classList.remove('hidden');
                    cameraView.srcObject = stream;
                    
                    const track = stream.getVideoTracks()[0];
                    const capabilities = track.getCapabilities();
                    if (capabilities.torch) {
                        flashButton.classList.remove('hidden');
                    }
                } catch (err) {
                    console.error("Camera error:", err);
                    alert("Could not access the camera. Please ensure you have given permission.");
                }
            } else {
                alert("Your browser does not support camera access.");
            }
        }

        function capturePhoto() {
            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraView.videoWidth;
            cameraCanvas.height = cameraView.videoHeight;
            context.drawImage(cameraView, 0, 0, cameraCanvas.width, cameraCanvas.height);
            
            cameraView.classList.add('hidden');
            cameraCanvas.classList.remove('hidden');
            cameraControls.classList.add('hidden');
            recaptureControls.classList.remove('hidden');
        }
        
        function recapturePhoto() {
            cameraView.classList.remove('hidden');
            cameraCanvas.classList.add('hidden');
            cameraControls.classList.remove('hidden');
            recaptureControls.classList.add('hidden');
        }

        function usePhoto() {
            cameraCanvas.toBlob(blob => {
                const capturedFile = new File([blob], "capture.jpg", { type: "image/jpeg" });
                handleFile(capturedFile);
            }, 'image/jpeg');
            closeCamera();
        }

        function toggleFlash() {
            if (stream) {
                const track = stream.getVideoTracks()[0];
                flashOn = !flashOn;
                track.applyConstraints({
                    advanced: [{ torch: flashOn }]
                });
                flashButton.classList.toggle('bg-yellow-400', flashOn);
                flashButton.classList.toggle('bg-gray-300', !flashOn);
            }
        }

        function handleFocus(e) {
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const focusRing = document.createElement('div');
            focusRing.className = 'focus-ring';
            focusRing.style.left = `${x - 30}px`;
            focusRing.style.top = `${y - 30}px`;
            
            e.target.parentNode.appendChild(focusRing);
            setTimeout(() => focusRing.remove(), 500);
        }

        function closeCamera() {
            if (stream) {
                if (flashOn) {
                    toggleFlash(); // Turn off flash if it's on
                }
                stream.getTracks().forEach(track => track.stop());
            }
            cameraModal.classList.add('hidden');
            flashButton.classList.add('hidden');
            recapturePhoto(); // Reset view for next time
        }

        async function getAnalysis(file) {
            if (!API_KEY || API_KEY === "YOUR_API_KEY") {
                alert("Please enter your Gemini API key in the script.");
                return;
            }
            imagePreviewContainer.classList.add('scanning');
            analyzeButton.disabled = true;
            analyzeButton.textContent = "Analyzing...";
            
            setTimeout(async () => {
                imagePreviewContainer.classList.add('hidden');
                loader.classList.remove('hidden');

                const base64Image = await fileToBase64(file);
                const prompt = `
                    Perform a professional, clinical-grade analysis of the food label for an Indian user.
                    You MUST respond with only a valid JSON object.
                    The JSON object must have a key "scores" containing 6 parameter objects.
                    For each parameter, provide a "score" (0-10) and a brief "reason".
                    For "processing_additives", also include an "additives" array of strings found.
                    For "carcinogenic_risk", the score is binary (0 for risk, 10 for none).

                    1.  **glycemic_nutrient_density**: Score based on glycemic impact (refined vs. whole carbs) and nutrient density. High fiber and protein improve the score.
                    2.  **micronutrient_bioavailability**: Score based on key vitamins/minerals (Iron, Vit D, Calcium) relevant to Indian deficiencies.
                    3.  **health_trifecta**: Score based on the "Health Trifecta": Added Sugar, Sodium, and Saturated/Trans Fats. High levels get a low score.
                    4.  **ingredient_quality**: Score based on the quality of main ingredients (e.g., whole grains vs. refined flour, healthy oils vs. palm oil).
                    5.  **processing_additives**: Score based on the length of the ingredients list and presence of artificial additives. List found additives.
                    6.  **carcinogenic_risk**: Score 0 if any ingredient is a known or suspected carcinogen (e.g., certain artificial sweeteners, preservatives like nitrates). Otherwise, score 10.

                    Example:
                    {
                      "scores": {
                        "glycemic_nutrient_density": { "score": 7, "reason": "Moderate glycemic impact due to whole grains." },
                        "micronutrient_bioavailability": { "score": 5, "reason": "Contains some calcium but lacks iron." },
                        "health_trifecta": { "score": 2, "reason": "High in sodium and added sugar." },
                        "ingredient_quality": { "score": 3, "reason": "Uses refined palm oil." },
                        "processing_additives": { "score": 6, "reason": "Contains some preservatives.", "additives": ["Sodium Benzoate"] },
                        "carcinogenic_risk": { "score": 10, "reason": "No carcinogenic ingredients found." }
                      }
                    }
                `;

                try {
                    const response = await makeGeminiRequest(prompt, base64Image);
                    lastAnalysisData = response.scores; // Store for chat
                    displayResults(lastAnalysisData);
                } catch (error) {
                    handleError(error);
                } finally {
                    loader.classList.add('hidden');
                    imagePreviewContainer.classList.remove('scanning');
                    analyzeButton.disabled = false;
                    analyzeButton.textContent = "Analyze Label";
                }
            }, 2000); // Wait for scanning animation
        }

        function displayResults(scores) {
            scoreBreakdown.innerHTML = '';
            
            const weights = {
                glycemic_nutrient_density: 0.20,
                micronutrient_bioavailability: 0.10,
                health_trifecta: 0.30,
                ingredient_quality: 0.15,
                processing_additives: 0.15,
                carcinogenic_risk: 0.10
            };

            let weightedScore = 0;
            for (const key in scores) {
                weightedScore += scores[key].score * weights[key];
            }
            
            if (scores.carcinogenic_risk.score === 0) {
                weightedScore = Math.min(weightedScore, 4.0);
            }

            const finalGrade = getGrade(weightedScore);

            const parameterDetails = {
                glycemic_nutrient_density: { title: "Glycemic & Nutrient Density" },
                micronutrient_bioavailability: { title: "Vitamins & Minerals" },
                health_trifecta: { title: "The Health Trifecta (Sugar, Salt, Fat)" },
                ingredient_quality: { title: "Ingredient Quality" },
                processing_additives: { title: "Processing & Additives" },
                carcinogenic_risk: { title: "Carcinogenic Risk" }
            };

            for (const key in scores) {
                const scoreData = scores[key];
                const scoreColor = scoreData.score >= 8 ? 'text-green-600' : scoreData.score >= 5 ? 'text-yellow-600' : 'text-red-600';
                
                let reasonHtml = `<p class="text-sm text-gray-500">${scoreData.reason}</p>`;
                if (key === 'processing_additives' && scoreData.additives && scoreData.additives.length > 0) {
                    const additivesHtml = scoreData.additives.map(name => `<span class="clickable-additive" onclick="showAdditiveInfo('${name}')">${name}</span>`).join(', ');
                    reasonHtml += `<p class="text-sm text-gray-500 mt-1">Found: ${additivesHtml}</p>`;
                }

                const breakdownItem = `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg shadow-sm">
                        <div>
                            <p class="font-semibold text-gray-800">${parameterDetails[key].title} ${key === 'carcinogenic_risk' && scoreData.score === 0 ? icons.carcinogen : ''}</p>
                            ${reasonHtml}
                        </div>
                        <div class="text-lg font-bold ${scoreColor} ml-4 whitespace-nowrap">${scoreData.score} / 10</div>
                    </div>
                `;
                scoreBreakdown.innerHTML += breakdownItem;
            }
            
            scoreSummary.innerHTML = `
                ${finalGrade.icon}
                <p class="text-5xl font-bold text-gray-800 mt-2">${finalGrade.letter}</p>
                <p class="text-lg font-semibold ${finalGrade.color} mt-1">${finalGrade.verdict}</p>
            `;
            
            results.classList.add('visible');
            chatExplainer.classList.remove('hidden');
        }
        
        function getGrade(score) {
            if (score >= 9) return { letter: 'A+', verdict: 'Excellent choice. Safe to consume regularly.', icon: icons.gradeA_plus, color: 'text-green-700' };
            if (score >= 8) return { letter: 'A', verdict: 'Very good choice. Consume freely.', icon: icons.gradeA, color: 'text-green-600' };
            if (score >= 7) return { letter: 'B', verdict: 'Good, but consume in moderation.', icon: icons.gradeB, color: 'text-yellow-600' };
            if (score >= 5) return { letter: 'C', verdict: 'Acceptable, but eat only occasionally.', icon: icons.gradeC, color: 'text-orange-600' };
            return { letter: 'D', verdict: 'Poor choice. Best to avoid.', icon: icons.gradeD, color: 'text-red-700' };
        }

        async function showAdditiveInfo(additiveName) {
            openModal();
            modalTitle.textContent = additiveName;
            modalBody.innerHTML = `<div class="loader mx-auto"></div>`;

            const prompt = `Explain the food additive "${additiveName}" in simple terms. What is it used for, and what are its potential health impacts?`;
            try {
                const response = await makeGeminiRequest(prompt);
                modalBody.textContent = response.text;
            } catch (error) {
                modalBody.textContent = "Could not fetch information. Please try again.";
                handleError(error);
            }
        }

        async function getPersonalizedExplanation() {
            if (!lastAnalysisData) return;
            
            const age = document.getElementById('user-age').value;
            const lifestyle = document.getElementById('user-lifestyle').value;
            const analysisSummary = JSON.stringify(lastAnalysisData);

            askWhyButton.disabled = true;
            askWhyButton.textContent = "Thinking...";
            chatResponseContainer.classList.remove('hidden');
            chatResponse.innerHTML = `<div class="loader mx-auto"></div>`;
            
            const prompt = `
                Based on the following food analysis data: ${analysisSummary}.
                Act as a very friendly, caring, and supportive doctor explaining this food's health impact to a patient. The patient is ${age || 'an adult'} years old with a ${lifestyle} lifestyle.

                Your response must be structured with the following markdown headings. Be concise and use simple, encouraging language.

                **The Good Stuff:**
                (A short, positive point about its benefits.)

                **A Little Caution:**
                (A gentle, supportive explanation of the drawbacks. For example, "It's a bit high in salt, so it's good to be mindful of that for your heart health.")

                **Healthier Swaps:**
                (Suggest three simple, varied Indian alternatives. For example, "roasted makhana, a bowl of curd, or a small banana".)

                **My Friendly Advice:**
                (A warm, personalized tip that is encouraging, not judgmental. For example, "For your activity level, focusing on whole foods will give you the best kind of fuel for your day.")

                **The Bottom Line:**
                (A one-line summary verdict, like "This is a nice treat for once in a while, but maybe not an everyday snack.")
            `;

            try {
                const response = await makeGeminiRequest(prompt);
                chatResponse.innerHTML = response.text
                    .replace(/\*\*(.*?):\*\*/g, '<p class="mt-2"><strong>$1:</strong></p>')
                    .replace(/\n/g, '<br>');
            } catch (error) {
                chatResponse.textContent = "Sorry, I couldn't generate a personalized explanation right now.";
                handleError(error);
            } finally {
                askWhyButton.disabled = false;
                askWhyButton.textContent = "ðŸ’¬ Ask Why?";
            }
        }

        async function makeGeminiRequest(prompt, base64Image = null) {
            const parts = [{ text: prompt }];
            if (base64Image) {
                parts.push({ inline_data: { mime_type: file.type, data: base64Image } });
            }

            const body = {
                contents: [{ parts }],
                generationConfig: { responseMimeType: "application/json" }
            };
            
            if (!base64Image) {
                delete body.generationConfig;
            }

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!response.ok) { throw new Error(`API Error: ${response.status}`); }
            
            const data = await response.json();
            const responseText = data.candidates[0].content.parts[0].text;
            
            return base64Image ? JSON.parse(responseText) : { text: responseText };
        }

        function handleError(error) {
            console.error("Error:", error);
            alert(`An error occurred: ${error.message}. Check the console for details.`);
            resetUI();
        }
        
        function openModal() { additiveModal.classList.remove('hidden'); }
        function closeModal() { additiveModal.classList.add('hidden'); }

        function resetUI() {
            file = null;
            lastAnalysisData = null;
            fileInput.value = '';
            uploader.classList.remove('hidden');
            imagePreviewContainer.classList.add('hidden');
            loader.classList.add('hidden');
            results.classList.remove('visible');
            chatExplainer.classList.add('hidden');
            chatResponseContainer.classList.add('hidden');
            chatResponse.innerHTML = '';
            document.getElementById('user-age').value = '';
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>
